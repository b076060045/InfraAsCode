---
- name: 在 GCP 機器上安裝 Docker (修正版)
  hosts: _env_dev
  become: true
  gather_facts: true

  tasks:
    - name: 1. 移除先前錯誤的 Ubuntu 源 (清理環境)
      file:
        path: /etc/apt/sources.list.d/docker.list
        state: absent

    - name: 2. 更新 apt 並安裝基礎套件
      apt:
        name: [apt-transport-https, ca-certificates, curl, gnupg, lsb-release]
        state: present
        update_cache: true

    - name: 3. 建立 keyrings 目錄
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: 4. 下載 GPG 金鑰 (自動辨識系統)
      get_url:
        # 使用 ansible_os_family 判斷要抓 debian 還是 ubuntu 的金鑰
        url: "https://download.docker.com/linux/{{ ansible_distribution | lower }}/gpg"
        dest: /etc/apt/keyrings/docker.asc
        mode: '0644'

    - name: 5. 加入 Docker 套件來源 (正確版本)
      apt_repository:
        # 重點：這裡會自動抓 debian 或 ubuntu，以及對應的代號 (bullseye/jammy)
        repo: >
          deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.asc]
          https://download.docker.com/linux/{{ ansible_distribution | lower }}
          {{ ansible_distribution_release }} stable
        state: present
        update_cache: true
        filename: docker

    - name: 6. 安裝 Docker 組件
      apt:
        name: [docker-ce, docker-ce-cli, containerd.io, docker-buildx-plugin, docker-compose-plugin]
        state: present
        update_cache: true

    - name: 7. 啟動服務並加人群組
      service: { name: docker, state: started, enabled: true }
    
    - name: 8. 使用者加入 docker 群組
      user: { name: terraform, groups: docker, append: true }

    - name: 9. 驗證
      command: docker --version
      register: docker_ver
    
    - debug:
        msg: "安裝成功！系統偵測為 {{ ansible_distribution }} {{ ansible_distribution_release }}，Docker 版本：{{ docker_ver.stdout }}"